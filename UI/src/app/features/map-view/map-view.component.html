<div class="map-card h-full">
  <div class="map-card__header">
    <div>
      <h3 class="text-lg font-semibold text-slate-800">Route Map</h3>
      <p class="text-xs uppercase tracking-wide text-slate-500">
        Depot and customer layout ({{ customers.length }} customers)
      </p>
    </div>
    <div class="flex items-center gap-2 text-xs text-slate-500">
      ðŸšš Utilization {{ utilization | number: '1.0-1' }}%
    </div>
  </div>

  <div class="map-card__content">
    <div class="map-canvas" *ngIf="depot">
      <svg
        [attr.viewBox]="'0 0 ' + width + ' ' + height"
        preserveAspectRatio="xMidYMid meet"
        class="map-svg"
        id="cvrp-map"
      >
        <defs>
          <pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
            <path d="M 50 0 L 0 0 0 50" fill="none" stroke="#cbd5f5" stroke-width="0.5" opacity="0.3" />
          </pattern>
        </defs>
        <rect width="100%" height="100%" fill="url(#grid)" />

        <g class="map-routes">
          <g
            *ngFor="let route of routes; trackBy: trackByRoute"
            class="map-route"
            [class.map-route--dimmed]="isRouteDimmed(route)"
            [class.map-route--highlight]="isRouteHighlighted(route)"
          >
            <polyline
              class="map-route__line"
              [attr.points]="toPolyline(route.nodes)"
              [attr.stroke]="route.color || '#3b82f6'"
              [attr.stroke-width]="getRouteStrokeWidth(route)"
              fill="none"
              stroke-linecap="round"
              stroke-linejoin="round"
              [attr.stroke-opacity]="getRouteStrokeOpacity(route)"
            ></polyline>
            <ng-container *ngFor="let segment of getRouteSegments(route); trackBy: trackBySegment">
              <g
                class="map-segment"
                [attr.transform]="'rotate(' + segment.angle + ' ' + segment.midX + ' ' + segment.midY + ')'"
              >
                <text class="map-segment__label" [attr.x]="segment.midX" [attr.y]="segment.midY">
                  {{ segment.label }}
                </text>
              </g>
            </ng-container>
          </g>
        </g>

        <g class="map-customers">
          <g *ngFor="let customer of customers">
            <circle
              [attr.cx]="scaleX(customer.x)"
              [attr.cy]="scaleY(customer.y)"
              r="6"
              class="map-node map-node--customer"
            >
              <title>
                Customer {{ customer.id }} â€¢ Demand: {{ customer.demand }}
              </title>
            </circle>
            <text
              [attr.x]="scaleX(customer.x) + 10"
              [attr.y]="scaleY(customer.y) + 4"
              class="map-node__label"
            >
              {{ customer.id }}
            </text>
          </g>
        </g>

        <g class="map-depot" *ngIf="depot as depotPoint">
          <circle
            [attr.cx]="scaleX(depotPoint.x)"
            [attr.cy]="scaleY(depotPoint.y)"
            r="12"
            class="map-node map-node--depot"
          >
            <title>Depot â€¢ Origin</title>
          </circle>
          <text
            [attr.x]="scaleX(depotPoint.x) + 14"
            [attr.y]="scaleY(depotPoint.y) + 4"
            class="map-node__label map-node__label--depot"
          >
            Depot
          </text>
        </g>
      </svg>
    </div>
  </div>
</div>
